<!DOCTYPE HTML>
<html lang="en" class="light" dir="">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Docker - Ouinet Documentation</title>


        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../FontAwesome/css/all.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <link rel="stylesheet" href="../FontAwesome/css/all.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var body = document.querySelector('body');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
		<img src="../img/ouinet-logo.png" style="width:200px">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Welcome</a></li><li class="chapter-item expanded "><a href="../intro/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../build/index.html"><strong aria-hidden="true">2.</strong> Building from Source</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../build/docker.html" class="active"><strong aria-hidden="true">2.1.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../build/vagrant.html"><strong aria-hidden="true">2.2.</strong> Vagrant</a></li><li class="chapter-item expanded "><a href="../build/testing.html"><strong aria-hidden="true">2.3.</strong> Testing</a></li></ol></li><li class="chapter-item expanded "><a href="../integration/index.html"><strong aria-hidden="true">3.</strong> Integration Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../integration/examples.html"><strong aria-hidden="true">3.1.</strong> Example Apps</a></li></ol></li><li class="chapter-item expanded "><a href="../how/index.html"><strong aria-hidden="true">4.</strong> How it Works</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../how/components.html"><strong aria-hidden="true">4.1.</strong> Actors and Components</a></li><li class="chapter-item expanded "><a href="../how/content.html"><strong aria-hidden="true">4.2.</strong> Content Access Systems</a></li><li class="chapter-item expanded "><a href="../how/cache.html"><strong aria-hidden="true">4.3.</strong> Distributed Cache</a></li><li class="chapter-item expanded "><a href="../how/injectors.html"><strong aria-hidden="true">4.4.</strong> Injector Servers</a></li><li class="chapter-item expanded "><a href="../how/client.html"><strong aria-hidden="true">4.5.</strong> Client Library</a></li></ol></li><li class="chapter-item expanded "><a href="../contribute/index.html"><strong aria-hidden="true">5.</strong> Contribute</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ouinet Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="docker"><a class="header" href="#docker">Docker</a></h1>
<h2 id="docker-development-environment"><a class="header" href="#docker-development-environment">Docker development environment</a></h2>
<p>We provide a <em>bootstrap</em> Docker image which is automatically updated with each
commit and provides all prerequisites for building the latest Oiunet desktop
binaries and Android libraries.</p>
<p>To exchange with the container data like Ouinet's source code and cached
downloads and build files, we will bind mount the following directories to
<code>/usr/local/src/</code> in the container (some we'll create first):</p>
<ul>
<li>source (assumed to be at the current directory),</li>
<li>build (in <code>../ouinet.build/</code>),</li>
<li>and the container's <code>$HOME</code> (in <code>../ouinet.home/</code>), where <code>.gradle</code>,
<code>.cargo</code>, etc. will reside.</li>
</ul>
<p>Note that with the following incantations you will not be able to use <code>sudo</code>
in the container (<code>--user</code>), and that all the changes besides those in bind
mounts will be lost after you exit (<code>--rm</code>).</p>
<pre><code class="language-sh">mkdir -p ../ouinet.build/ ../ouinet.home/
sudo docker run \
  --rm -it \
  --user $(id -u):$(id -g) \
  --mount type=bind,source=&quot;$(pwd)&quot;,target=/usr/local/src/ouinet \
  --mount type=bind,source=&quot;$(pwd)/../ouinet.build&quot;,target=/usr/local/src/ouinet.build \
  --mount type=bind,source=&quot;$(pwd)/../ouinet.home&quot;,target=/mnt/home \
  -e HOME=/mnt/home \
  registry.gitlab.com/equalitie/ouinet:android
</code></pre>
<p>If you only need to build Ouinet desktop binaries, you may replace the image
name at the end of the command with <code>registry.gitlab.com/equalitie/ouinet</code>,
which is much lighter.</p>
<p>After running the command, you should find yourself in a new terminal, ready
to accept the build instructions described elsewhere in the document.</p>
<p>Please consult the GitLab CI scripts to see how to build your own bootstrap
images locally.</p>
<h2 id="docker-deployment"><a class="header" href="#docker-deployment">Docker deployment</a></h2>
<p>Ouinet injectors and clients can be run as Docker containers.  An application
configuration file for Docker Compose is included for easily deploying all
needed volumes and containers.</p>
<p>To run a Ouinet node container only a couple hundred MiB are needed, plus the
space devoted to the data volume (which may grow considerably larger in the
case of the injector).</p>
<p>A <code>Dockerfile</code> is also included that can be used to create a Docker image
which contains the Ouinet injector, client and necessary software dependencies
running on top of a Debian base system.</p>
<h3 id="building-the-image"><a class="header" href="#building-the-image">Building the image</a></h3>
<p>Ouinet Docker images should be available from the Docker Hub.  Follow the
instructions in this section if you still want to build the image yourself.
You will need around 3 GiB of disk space.</p>
<p>You may use the <code>Dockerfile</code> as included in Ouinet's source code, or you
can just <a href="https://raw.githubusercontent.com/equalitie/ouinet/master/Dockerfile">download it</a>.  Then build the image by running:</p>
<pre><code>$ sudo docker build -t equalitie/ouinet:latest - &lt; Dockerfile
</code></pre>
<p>That command will build a default recommended version, which you can override
with <code>--build-arg OUINET_VERSION=&lt;VERSION&gt;</code>.</p>
<p>After a while you will get the <code>equalitie/ouinet:latest</code> image.  Then you may
want to run <code>sudo docker prune</code> to free up the space taken by temporary
builder images (which may amount to a couple of GiB).</p>
<h4 id="debugging-enabled-image"><a class="header" href="#debugging-enabled-image">Debugging-enabled image</a></h4>
<p>You can also build an alternative version of the image where programs contain
debugging symbols and they are run under <code>gdb</code>, which shows a backtrace in
case of a crash.  Just add <code>--build-arg OUINET_DEBUG=yes</code> to the build
command.  We recommend that you use a different tag for these images
(e.g. <code>equalitie/ouinet:&lt;VERSION&gt;-debug</code>).</p>
<p>Depending on your Docker setup, you may need to change the container's
security profile and give it tracing capabilities.  For more information, see
<a href="https://stackoverflow.com/q/35860527">this thread</a>.</p>
<h3 id="deploying-a-client"><a class="header" href="#deploying-a-client">Deploying a client</a></h3>
<p>You may use <a href="https://docs.docker.com/compose/">Docker Compose</a> with the
<code>docker-compose.yml</code> file included in Ouinet's source code (or you can just
<a href="https://raw.githubusercontent.com/equalitie/ouinet/master/docker-compose.yml">download it</a>).  Whenever you run <code>docker-compose</code>
commands using that configuration file, you must be in the directory where the
file resides.</p>
<p>If you want to create a client that seeds a static cache root (see below) from
a directory in the host, check the instructions in <code>docker-compose.yml</code>.</p>
<p>If you just plan to <strong>run a single client</strong> with the latest code on your
computer, you should be fine with running the following command:</p>
<pre><code>$ sudo docker-compose up
</code></pre>
<p>That command will create a <em>data volume</em>, a main <em>node container</em> for running
the Ouinet client or injector (using the host's network directly), and a
convenience <em>shell container</em> (see below) to allow you to modify files in the
data volume.  It will then run the containers (the shell container will exit
immediately; this is normal).</p>
<p>To <strong>stop the node</strong>, hit Ctrl+C or run <code>sudo docker-compose stop</code>.  Please
note that with the default configuration in <code>docker-compose.yml</code>, the node
will be automatically restarted whenever it crashes or the host is rebooted,
until explicitly stopped.</p>
<p>A new client node which starts with no configuration will get a default one
from templates included in Ouinet's source code and it will be missing some
important parameters, so you may want to stop it (see above) and use the
<strong>shell container</strong> (see below) to edit <code>client/ouinet-client.conf</code>:</p>
<ul>
<li>If using a local test injector, set its endpoint in option <code>injector-ep</code>.</li>
<li>Set the injector's credentials in option <code>injector-credentials</code>.</li>
<li>Unless using a local test injector, set option <code>injector-tls-cert-file</code> to
<code>/var/opt/ouinet/client/ssl-inj-cert.pem</code> and copy the injector's TLS
certificate to that file.</li>
<li>Set the public key used by the injector for HTTP signatures in option
<code>cache-http-public-key</code>.</li>
<li>To enable the distributed cache, set option <code>cache-type</code>.  The only value
currently supported is <code>bep5-http</code>.</li>
</ul>
<p>After you have set up your client's configuration, you can <strong>restart it</strong>.
The client's HTTP proxy endpoint should be available to the host at
<code>localhost</code> port 8077.</p>
<p>If you get a &quot;connection refused&quot; error when using the client's proxy, your
Docker setup may not support host networking.  To enable port forwarding,
follow the instructions in <code>docker-compose.yml</code>.</p>
<p>Finally, restart the client container.</p>
<h3 id="using-the-shell-container"><a class="header" href="#using-the-shell-container">Using the shell container</a></h3>
<p>You may use the convenience <em>shell container</em> to access Ouinet node files
directly:</p>
<pre><code>$ sudo docker-compose run --rm shell
</code></pre>
<p>This will create a throwaway container with a shell at the <code>/var/opt/ouinet</code>
directory in the data volume.</p>
<p>If you want to <em>transfer an existing repository</em> to <code>/var/opt/ouinet</code>, you
first need to move away or remove the existing one using the shell container:</p>
<pre><code># mv REPO REPO.old  # REPO is either 'injector' or 'client'
</code></pre>
<p>Then you may copy it in from the host using:</p>
<pre><code>$ sudo docker cp /path/to/REPO SHELL_CONTAINER:/var/opt/ouinet/REPO
</code></pre>
<h3 id="other-deployments"><a class="header" href="#other-deployments">Other deployments</a></h3>
<p>If you plan on running several nodes on the same host you will need to use
different explicit Docker Compose project names for them.  To make the node an
injector instead of a client you need to set <code>OUINET_ROLE=injector</code>.  To make
the container use a particular image version instead of <code>latest</code>, set
<code>OUINET_VERSION</code>.  To limit the amount of memory that the container may use,
set <code>OUINET_MEM_LIMIT</code>, but you will need to pass the <code>--compatibility</code> option
to <code>docker-compose</code>.</p>
<p>An easy way to set all these parameters is to copy or link the
<code>docker-compose.yml</code> file to a directory with the desired project name and
populate its default environment file:</p>
<pre><code>$ mkdir -p /path/to/ouinet-injector  # ouinet-injector is the project name
$ cd /path/to/ouinet-injector
$ cp /path/to/docker-compose.yml .
$ echo OUINET_ROLE=injector &gt;&gt; .env
$ echo OUINET_VERSION=v0.1.0 &gt;&gt; .env
$ echo OUINET_MEM_LIMIT=6g &gt;&gt; .env
$ sudo docker-compose --compatibility up
</code></pre>
<h3 id="injector-container"><a class="header" href="#injector-container">Injector container</a></h3>
<p>After an injector has finished starting, you may want to use the shell
container to inspect and note down the contents of <code>injector/endpoint-*</code>
(injector endpoints) and <code>injector/ed25519-public-key</code> (public key for HTTP
signatures) to be used by clients.  The injector will also generate a
<code>tls-cert.pem</code> file which you should distribute to clients for TLS access.
Other configuration information like credentials can be found in
<code>injector/ouinet-injector.conf</code>.</p>
<p>Remember that the injector will be available as an HTTP proxy for anyone
having its credentials; if you want to disable this feature, set
<code>disable-proxy = true</code>.  You can also restrict the URLs injected to those
matching a regular expression with the <code>restricted</code> option.</p>
<p>To start the injector in headless mode, you can run:</p>
<pre><code>$ sudo docker-compose up -d
</code></pre>
<p>You will need to use <code>sudo docker-compose stop</code> to stop the container.</p>
<p>To be able to follow its logs, you can run:</p>
<pre><code>$ sudo docker-compose logs --tail=100 -ft
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../build/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../build/vagrant.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../build/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../build/vagrant.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
